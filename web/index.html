<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="author" content="Guy Taylor">

    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="favicon-128.png" sizes="128x128" />
    <link rel="icon" href="favicon.ico">
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="mstile-310x310.png" />

    <meta name="application-name" content="RESTful SunSaver"/>
    <title>RESTful SunSaver</title>
    <meta name="description" content="">

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/metrics-graphics/2.11.0/metricsgraphics.min.css" integrity="sha256-h2N0mv6gOweJh0+fSdARkYlmOPoWUnzzQmQuVkF4DSQ=" crossorigin="anonymous" />
  </head>

  <body>

    <nav class="navbar navbar-toggleable-md navbar-inverse fixed-top bg-inverse">
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <a class="navbar-brand" href="#">Navbar</a>

      <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item active">
            <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Link</a>
          </li>
          <li class="nav-item">
            <a class="nav-link disabled" href="#">Disabled</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="http://example.com" id="dropdown01" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Dropdown</a>
            <div class="dropdown-menu" aria-labelledby="dropdown01">
              <a class="dropdown-item" href="#">Action</a>
              <a class="dropdown-item" href="#">Another action</a>
              <a class="dropdown-item" href="#">Something else here</a>
            </div>
          </li>
        </ul>
        <form class="form-inline my-2 my-lg-0">
          <input class="form-control mr-sm-2" type="text" placeholder="Search">
          <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
        </form>
      </div>
    </nav>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1 class="display-3">SunSaver MPPT</h1>
        <p>Live and recored data from the SunSaver MPPT</p>
        <p><a class="btn btn-primary btn-lg" href="#" role="button">API</a></p>
      </div>
    </div>

    <!-- realtime graph -->
    <div class="container">
      <div class="row">
        <h1>Realtime Data</h1>
        <div id="realtime_generation" class="col col-12"></div>
        <div id="realtime_battery" class="col col-12"></div>
        <div id="realtime_load" class="col col-12"></div>
        <div id="realtime_temperature" class="col col-12"></div>
      </div>
    </div>

    <hr>

    <!-- 30day graph -->
    <div class="container">
        <h1>30 Day Logged Data</h1>
        <div id="logged_battery" class="col col-12"></div>
        <div id="logged_load" class="col col-12"></div>
      </div>
    </div>
    
    <hr>

    <div class="container">
      <footer>
        <p>&copy; Company 2017</p>
      </footer>
    </div> <!-- /container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js" integrity="sha256-obZACiHd7gkOk9iIL/pimWMTJ4W/pBsKu+oZnSeBIek=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js" integrity="sha256-1hjUhpc44NwiNg8OwMu2QzJXhD8kcj+sJA3aCQZoUjg=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/store.js/1.3.20/store.min.js" integrity="sha256-0jgHNEQo7sIScbcI/Pc5GYJ+VosKM1mJ+fI0iuQ1a9E=" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha256-gL1ibrbVcRIHKlCO5OXOPC/lZz/gpdApgQAzskqqXp8=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.10.2/d3.min.js" integrity="sha256-9AVANlaB1o0L8ii1b78GD1K0oyjJofOaAk17Chn2qS4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/metrics-graphics/2.11.0/metricsgraphics.min.js" integrity="sha256-KpiHDqN/RY4aKfRnmlAUQi8On+GQFLYYLOh7yIwBb4c=" crossorigin="anonymous"></script>

    <script>
      var REALTIME_STATUS_KEYS = ['generation', 'storage', 'load', 'temperature'];
      var DATETIME_KEYS = _.union(REALTIME_STATUS_KEYS, ['markers']);
      var REAL_TIME_DATA_STORE_KEY = 'rt_data_v1';

      var realtime_data = (function() {
        var default_realtime_data = (function() {
          var result = {};
          _.each(DATETIME_KEYS, function(key) {
            result[key] = [];
          });
          return result;
        })();

        var realtime_data = store.get(REAL_TIME_DATA_STORE_KEY, default_realtime_data);
        store.set(REAL_TIME_DATA_STORE_KEY, realtime_data);
        return realtime_data;
      })();

      realtime_data = (function(data) {
        _.each(DATETIME_KEYS, function(key) {
          var sub_data = data[key];
          _.each(sub_data, function(item) {
            item['datetime'] = moment(item['datetime']).toDate();
          });
        });
        return data;
      })(realtime_data);

      var graphs = {};

      var plot_data_status = function(data) {
        if (data == null) return;

        //
        _.each(REALTIME_STATUS_KEYS, function(key) {
          var datetime = moment().toDate();
          var sub_data = data[key];
          sub_data['datetime'] = datetime;
          realtime_data[key].push(sub_data);
        });

        var last_state = _.last(realtime_data.markers);
        var state = data['storage']['charge_state'];
        if ( last_state === undefined || last_state.label !== state ) {
          var marker = {
            datetime: moment().toDate(),
            label: state,
          };
          realtime_data.markers.push(marker);
        }

        store.set(REAL_TIME_DATA_STORE_KEY, realtime_data);
        //
        
        var defaults = {
          height: 250,
          full_width: true,
          right: 55,
          left: 90,

          x_accessor: 'datetime',
          markers: realtime_data.markers,

          area: false,
          animate_on_load: true,
          chart_type: 'line',
          aggregate_rollover: true,
          min_y_from_data: true,

          linked: true,
          linked_format: 'realtime_%Y-%m-%d-%H-%M-%S',
        };

        if ( graphs.realtime_generation === undefined ) {
          graphs.generation = MG.data_graphic($.extend({}, defaults, {
            title: "Generation",
            target: '#realtime_generation',
            data: realtime_data.generation,
            legend: ['Voltage'],
            y_accessor: ['solar_input_voltage_filtered'],
            y_label: ['Volts'],
            aggregate_rollover: false,
          }));
        }

        if ( graphs.realtime_battery === undefined ) {
            MG.data_graphic($.extend({}, defaults, {
              title: "Battery",
              target: '#realtime_battery',
              data: realtime_data.storage,
              legend: ['Voltage', 'Current'],
              y_accessor: ['battery_voltage_filtered', 'battery_charge_current_filtered'],
              y_label: ['Volts', 'Amps'],
            }));
        }

        if ( graphs.realtime_load === undefined ) {
          MG.data_graphic($.extend({}, defaults, {
            title: "Load",
            target: '#realtime_load',
            data: realtime_data.load,
            legend: ['Voltage', 'Current'],
            y_accessor: ['load_voltage_filtered', 'load_current_filtered'],
            y_label: ['Volts', 'Amps'],
          }));
        }

        if ( graphs.realtime_temperature === undefined ) {
          MG.data_graphic($.extend({}, defaults, {
            title: "Temperature",
            target: '#realtime_temperature',
            data: realtime_data.temperature,
            legend: ['Heatsink', 'Battery', 'Ambient', 'Remote'],
            y_accessor: ['heatsink_temperature', 'battery_temperature', 'ambient_temperature', 'remote_temperature'],
            y_label: 'C',
          }));
        }
      };
      
      var plot_data_logged = function(data) {
        if (data == null) return;
        let days = data.days;
        var max_hourmeter = _.chain(days).pluck('hourmeter').max().value();
        var min_hourmeter = _.chain(days).pluck('hourmeter').min().value();

        days = _.map(days, function(day, i) {
          day.date = moment().subtract(i, "days").toDate();
          day.battery_charge_daily = day.battery_charge_daily || 1;
          return day;
        });

        var defaults = {
          data: days,

          height: 250,
          full_width: true,
          right: 55,
          left: 90,

          x_accessor: 'date',

          area: false,
          animate_on_load: true,
          chart_type: 'line',
          aggregate_rollover: true,
          min_y_from_data: true,

          linked: true,
          linked_format: 'logged_%Y-%m-%d',
        };

        if ( graphs.logged_battery === undefined ) {
          MG.data_graphic($.extend({}, defaults, {
            title: "Battery",
            target: '#logged_battery',
            legend: ['min','max'],
            y_accessor: ['battery_voltage_min', 'battery_voltage_max'],
            y_label: 'Volts',
          }));
        }

        if ( graphs.logged_load === undefined ) {
          MG.data_graphic($.extend({}, defaults, {
            title: "Power",
            target: '#logged_load',
            legend: ['Battery','Load'],
            y_accessor: ['battery_charge_daily', 'load_charge_daily'],
            y_label: 'Mili Amp Hours',
          }));
        }
      };

      var debug_should_use_fake_data = window.location.hash.includes("fake");

      // run status before logged as logged locks the API for a while.
      $(document).ready(function() {
        var url = debug_should_use_fake_data ? "/fake_data_status.json" : '/api/v1/status';

        var min_delay = moment.duration(2, 'seconds').asMilliseconds();
        var normal_delay = moment.duration(5, 'seconds').asMilliseconds();

        var plot = _.throttle(function() {
          d3.json(url, plot_data_status);
        }, min_delay);
        setInterval(plot, normal_delay);
        plot();
      });

      $(document).ready(function() {
        var url = debug_should_use_fake_data ? "/fake_data_logged.json" : '/api/v1/logged';

        var min_delay = moment.duration(1, 'hour').asMilliseconds();
        var normal_delay = moment.duration(3, 'hours').asMilliseconds();

        var plot = _.throttle(function() {
          d3.json(url, plot_data_logged);
        }, min_delay);
        setInterval(plot, normal_delay);
        plot();
      });

    </script>
  </body>
</html>
